//Alice's nightmare
//Custom instance Made by Lioran
//Custom map used haunt_1 and haunt_e made by Syouji
//If you have those map on your server, do not use them.
//I modified them for my instance.... and their names

//REWARDS
//I didn't set a reward for this instance.
//You will have to set it on your own
//Ctrl+F "/*Reward*/" to add them, 6 different possible reward.
//read their description


//---INSTANCE VARIABLES------
//'main_event
//1=instance just started
//2=first part of alice scene done
//3=second part of alice scene done
//4=monster killed portal is opend

//'aline_secret
//0=Not attempted
//1=fighting
//2=fought but lost
//3=fought and won

//'door_opened   aline door
//0=not opened
//1=opened

//quest item to get (not inventory items)
//0=no one got, -1=delivered , anything else is the id of the player that got it and needs to deliver it to Dead Magician. 
//'piano_got
//'herb_got
//'bottle_got
//'crystal_got
//'book_got

//'touch_crystal

//'hera_gid    her mob gid when is spawned
//'aline_gid   her mob gid when she is spawned
//'lord_gid    lord of hate gid when spawned

//---PLAYER VARIABLES------
//anightmare_rand	Random number generated by the instance when it starts to avoid a re-entry bug after instance ends
//anightmare_partyid	id of the party you were in when joining
//anightmare_timer	time of entry
//anightmare_wakeup	Alice quest variable also used to check if instance was finished before to skip dialogue
//anightmare_aline	Aline quest variable

//----Quest Starting NPC--------------------------
hollowtown,208,146,2	script	Alice#forest	10013,{
	set .@party_id,getcharid(1);
	set .@md_name$,"Alice's Nightmare";

	set .@anightmare_timer,checkquest(40400,PLAYTIME); // 20 hours so daily instance
	set .@anightmare_timer2,checkquest(40401,PLAYTIME); // 3 hours
	
	mes "[^0000ffAlice^000000]";
	mes "Help me...";
	next;
	mes "[^0000ff"+strcharinfo(0)+"^000000]";
	mes "She's going into the forest";
	next;
	if (instance_id()){
		set .@randn,'random_number;
		set .@text$,"Join Instance";
	}else{
		set .@randn,-1;
		set .@text$,"Create Instance";
	}
	
	if (.@anightmare_timer == 0 || .@anightmare_timer == 1){
		if (.@anightmare_timer2 == -1 || .@anightmare_timer2 == 2 || anightmare_rand!=.@randn){
							//show how long left
							set .@dun_lim_time,anightmare_timer+72000; // 1 week
							set .@dun_cur_time,gettimetick(2);
							set .@dun_ent_t,(.@dun_lim_time - .@dun_cur_time);
							set .@dun_h,(.@dun_ent_t / 3600);
							set .@dun_m,(.@dun_ent_t - (.@dun_h * 3600)) / 60;
							set .@dun_s,.@dun_ent_t - ((.@dun_h * 3600) + (.@dun_m * 60));

							mes "A tick dark fog is preventing you from going any further.";
							mes "";
							mes "^ff0000" + .@dun_h + " H " + .@dun_m + " M " + .@dun_s + " S before you can re-enter.";
							close;
		}else{
			if (.@party_id != anightmare_partyid) {
				mes "[^0000ff"+strcharinfo(0)+"^000000]";
				mes "My friends Abandonned me!";
				close;
			}
		}
	}else{
		//reset the random number if not in the instance time window
		if (anightmare_rand !=0){
			set anightmare_rand,0;
			erasequest 40400;
			erasequest 40401;
		}
		
	}
	
	switch(select("Follow her ("+.@text$+"):Don't follow her")) {
		case 1:
			mes "You Try to follow her into the forest.";
			next;
			//not in a 2 player party.
			if (!instance_check_party(.@party_id,2)) {
				mes "[^0000ff"+strcharinfo(0)+"^000000]";
				mes "Maybe I shouldn't do this alone.";
				close;
			}
			
			if (BaseLevel < 70){
				mes "[^0000ff"+strcharinfo(0)+"^000000]";
				mes "I don't think you are strong enough to handle this.";
				close;
			}
			
			if (getcharid(0) == getpartyleader(.@party_id,2)) {//check if party leader
				if (.@anightmare_timer == -1 || .@anightmare_timer == 2){//check if instance timer is done
					set .@i_inst,instance_create(.@md_name$); //start instance if possible
					if (.@i_inst !=0){
						set 'random_number,rand(1,9999998)+1;
						
					}
				}
			}
			switch(instance_enter("Alice's Nightmare")) {
				case IE_OTHER:
					mes "An unknown error has occurred.";
					close;
				case IE_NOINSTANCE:
					if (getcharid(0) != getpartyleader(.@party_id,2)) {
							//you'Re not the party leader and tried to engage the instance
							if (.@anightmare_timer == -1 || .@anightmare_timer == 2){
								mes "[^0000ff"+strcharinfo(0)+"^000000]";
								mes "I shouldn't be the one that engage.";
								close;
							}
							
						}
							//show how long left
							set .@dun_lim_time,anightmare_timer+72000; // 1 week
							set .@dun_cur_time,gettimetick(2);
							set .@dun_ent_t,(.@dun_lim_time - .@dun_cur_time);
							set .@dun_h,(.@dun_ent_t / 3600);
							set .@dun_m,(.@dun_ent_t - (.@dun_h * 3600)) / 60;
							set .@dun_s,.@dun_ent_t - ((.@dun_h * 3600) + (.@dun_m * 60));

							mes "A tick dark fog is preventing you from going any further.";
							mes "";
							mes "^ff0000" + .@dun_h + "H" + .@dun_m + "M" + .@dun_s + "S before you can re-enter.";
							close;
				case IE_NOMEMBER:
					//this should never happen
					mes "[^0000ff"+strcharinfo(0)+"^000000]";
					mes "Why am I alone?";
					close;
				case IE_OK:
					//someone is entering the instance
					mapannounce "hollowtown", strcharinfo(0) +" is venturing into the forest.",bc_map,"0x00ff99",FW_NORMAL,12;
					if ('main_event<3){
						if (anightmare_wakeup == 2){
							set anightmare_wakeup,3;
						}
					}
					if (.@anightmare_timer == -1 || .@anightmare_timer == 2){//check if instance timer is already set
						set anightmare_timer,gettimetick(2);
						set anightmare_partyid, getcharid(1);
						setquest 40400;
						setquest 40401;
						set anightmare_rand,'random_number;
					}
					close;
			}
		case 2:
			close;
		
	}
	end;

}
	

//----first room scene-------------------------
1@antgm,151,195,0	script	Alice#1	10013,{
	set .@party_id,getcharid(1);
	//only party leader engage the next part
	if (getcharid(0) != getpartyleader(.@party_id,2)) {
		mes "...";
		close;
	}
	
	if ('main_event == 1){
		mes "[^0000ffAlice^000000]";
		mes "I'm scared!";
		npctalk "Alice: I'm scared!";
		next;
		select("Are you ok?");
		unittalk 0,strcharinfo(0)+": Are you ok?";
		next;
		mes "[^0000ffAlice^000000]";
		mes "Ah!!!";
		npctalk "Alice: Ah!!!";
		next;
		enablenpc instance_npcname("Hera#1");
		mes "[^ff0000Hera^000000]";
		mes "What's that sweetie, you're scared?";
		npctalk ("Hera: What's that sweetie, you're scared?",instance_npcname("Hera#1"));
		next;
		mes "[^ff0000Hera^000000]";
		mes "Maybe you just need a hug.";
		npctalk "Hera: Maybe you just need a hug.",instance_npcname("Hera#1");
		next;
		unitwalk getnpcid(0,instance_npcname("Hera#1")),151,196;
		emotion ET_CHUP,getnpcid(0,instance_npcname("Hera#1"));
		mes "...";
		next;
		mes "[^0000ffAlice^000000]";
		mes "No!!!";
		npctalk "Alice: No!!!";
		next;
		movenpc instance_npcname("Hera#1"),151,198;
		mes "[^ff00ffHera^000000]";
		mes "Hahaha... You're so cute.";
		npctalk "Hera: Hahaha... You're so cute.",instance_npcname("Hera#1");
		next;
		mes "[^ff0000Hera^000000]";
		mes "Let's play a little game.";
		npctalk "Hera: Let's play a little game.",instance_npcname("Hera#1");
		next;
		specialeffect EF_READYPORTAL2,AREA,instance_npcname("Alice#1");//warp portal effect
		mes "[^0000ffAlice^000000]";
		mes "!";
		emotion ET_SURPRISE;
		npctalk "Alice: !";
		next;
		specialeffect 6,AREA,instance_npcname("Alice#1");//warping effect
		set 'main_event,2;
		disablenpc instance_npcname("Alice#1");
		mes "...";
		select("What did you do to her?");
		unittalk 0,strcharinfo(0)+": What did you do to her?";
		next;
		mes "[^ff0000Hera^000000]";
		mes "Maybe you can be part of our game.";
		npctalk "Hera: Maybe you can be part of our game.",instance_npcname("Hera#1");
		next;
		mes "[^ff0000Hera^000000]";
		mes "Why don't you follow me inside.";
		npctalk "Hera: Why don't you follow me inside.",instance_npcname("Hera#1");
		close2;
		specialeffect 44,AREA,instance_npcname("Hera#1");//smoke puff
		specialeffect 53,AREA,instance_npcname("Hera#1");//smoke puff
		emotion ET_SMILE,getnpcid(0,instance_npcname("Hera#1"));
		set .@entrace_spawn$,instance_npcname("anightmare#1")+"::OnMobDead";
		
		areamonster 'first_map$,145,194,159,181,"Remenent of Hate",3401,3,.@entrace_spawn$;
		areamonster 'first_map$,145,194,159,181,"Carrier of Hate",3402,2,.@entrace_spawn$;
		
		monster ('first_map$,151,195,"Carrier of Hate",3403,1,.@entrace_spawn$);
		unittalk $@mobid[0],"Shadow: Hate will bring you joy.";
		
		set 'main_event,3;
		disablenpc instance_npcname("Hera#1");
		
		end;
	}
	mes "Ah!!!";
	close;
	
}

1@antgm,151,198,4	script	Hera#1	3400,{
	if (getcharid(0) != getpartyleader(getcharid(1),2) || 'main_event != 2) {
		mes "...";
		close;
	}
		mes "...";
		select("What did you do to her?");
		unittalk 0,strcharinfo(0)+": What did you do to her?";
		next;
		mes "[^ff0000Hera^000000]";
		mes "Maybe you can be part of our game.";
		npctalk "Hera: Maybe you can be part of our game.",instance_npcname("Hera#1");
		next;
		mes "[^ff0000Hera^000000]";
		mes "Why don't you follow me inside.";
		npctalk "Hera: Why don't you follow me inside.",instance_npcname("Hera#1");
		close2;
		set 'main_event,3;
		specialeffect 44,AREA,instance_npcname("Hera#1");//smoke puff
		specialeffect 53,AREA,instance_npcname("Hera#1");//smoke puff
		emotion ET_SMILE;
		set .@entrace_spawn$,instance_npcname("anightmare#1")+"::OnMobDead";

		areamonster 'first_map$,145,194,159,181,"Remenent of Hate",3401,3,.@entrace_spawn$;
		areamonster 'first_map$,145,194,159,181,"Carrier of Hate",3402,2,.@entrace_spawn$;
		monster ('first_map$,151,195,"Shadow of Hate",3403,1,.@entrace_spawn$);
		unittalk $@mobid[0],"Shadow: Hate will bring you joy.";
		disablenpc instance_npcname("Hera#1");
		end;
	

	
}

1@antgm,3,3,4	script	anightmare#1	45,1,1,{

	mes "...";
	close;

	
OnInstanceInit:
	hideonnpc instance_npcname("anightmare#1");
	set 'first_map$,instance_mapname("1@antgm");
	set 'second_map$,instance_mapname("2@antgm");
	set 'third_map$,instance_mapname("3@antgm");
	set 'main_event,1;
	set 'aline_secret,0;
	set 'door_opened,0;
	
	set 'piano_got,0;
	set 'bottle_got,0;
	set 'book_got,0;
	set 'crystal_got,0;
	set 'herb_got,0;
	set 'touch_crystal,0;
	
	disablenpc instance_npcname("Hera#1");
	disablenpc instance_npcname("outsidewarp#1");
	monster 'first_map$,166,187,"Loli Ruri",1505,1;
	monster 'first_map$,143,184,"Loli Ruri",1505,1;
	monster 'first_map$,152,179,"Bloody Murderer",1507,1;
	monster 'first_map$,150,165,"Hylozoist",1510,1;
	monster 'first_map$,153,171,"Hylozoist",1510,1;
	set .@lude_spawn$, instance_npcname("anightmare#1")+"::OnLudeDead";
	monster 'first_map$,150,161,"Lude",1509,1,.@lude_spawn$;
	monster 'first_map$,118,189,"Lude",1509,1,.@lude_spawn$;
	monster 'first_map$,180,203,"Lude",1509,1,.@lude_spawn$;
	monster 'first_map$,153,167,"Quve",1508,1,.@lude_spawn$;
	end;

	
OnLudeDead:
	addtimer 40000+rand(1,20000),instance_npcname("anightmare#1")+"::OnLudeTimer";
	end;
	
OnMobDead:
		if (mobcount('first_map$,instance_npcname("anightmare#1")+"::OnMobDead") < 1) {
			enablenpc instance_npcname("outsidewarp#1");
			set 'main_event,4;
			
			mapannounce 'first_map$,"Hera: This is gonna be so much fun!",bc_map,"0xFF0000",FW_NORMAL,12;
		}
		end;

OnLudeTimer:
		set .@lude_spawn$, instance_npcname("anightmare#1")+"::OnLudeDead";
		switch (rand(1,4)){
			case 1:
				monster 'first_map$,182,192,"Lude",1509,1,.@lude_spawn$;
				end;
			case 2:
				monster 'first_map$,190,184,"Lude",1509,1,.@lude_spawn$;
				end;
			case 3:
				monster 'first_map$,194,192,"Lude",1509,1,.@lude_spawn$;
				end;
			case 4:
				monster 'first_map$,186,193,"Quve",1508,1,.@lude_spawn$;
				end;
		}
	end;

}

1@antgm,151,200,4	script	outsidewarp#1	45,1,1,{
	mes "...";
	close;
	
OnTouch:
	warp 'second_map$,20,156;
	end;
	
}

2@antgm,18,154,4	script	insidewarp#1	45,1,1,{
	mes "...";
	close;
	
OnTouch:
	warp 'first_map$,152,196;
	end;
	
}

//map 2 spawn master
2@antgm,91,125,4	script	anightmare#2	45,10,10,{
OnInstanceInit:
	hideonnpc instance_npcname("anightmare#2");
	set .@npc_name$,instance_npcname("anightmare#2");
	setwall 'second_map$,126,12,8,0,0,'second_map$+"anightmare_walllist0";
	setwall 'second_map$,132,173,4,0,0,'second_map$+"anightmare_walllist1";

	end;
	
OnInstanceDestroy:
	delwall 'second_map$+"anightmare_walllist0";
	delwall 'second_map$+"anightmare_walllist1";
	end;
	
OnTimer500:
	stopnpctimer;
	
	if ('main_event == 5){
		if (mobcount('second_map$,instance_npcname("anightmare#2")+"::OnFakeHera") < 1) {
			mapannounce 'second_map$,"Hera: I'm sorry, did that scare you?",bc_map,"0xFF0000",FW_NORMAL,12;
			initnpctimer instance_npcname("Dead Magician#anightmare1");
			set 'main_event,6;
			set .@guard_spawn$,instance_npcname("anightmare#2")+"::OnGuardSpawn";
			areamonster 'second_map$,119,18,123,13,"Remenent of Hate",3401,1,.@guard_spawn$;
			areamonster 'second_map$,119,18,123,13,"Carrier of Hate",3402,1,.@guard_spawn$;
			areamonster 'second_map$,119,18,123,13,"Shadow of Hate",3403,3,.@guard_spawn$;
			end;
		}
		initnpctimer;
		end;
	}
	if ('main_event != 7){end;}
	
	getunitdata 'hera_gid,.@hera_hp;
	if (.@hera_hp[UMOB_HP]<2600000){
			makeitem "Well_Baked_Cookie",1,'second_map$,.@hera_hp[UMOB_X],.@hera_hp[UMOB_Y];
			unitwarp 'hera_gid,'second_map$,190,105;
			unitkill 'hera_gid;
			set 'hera_gid,0;
			set 'main_event,8;
			delwall 'second_map$+"anightmare_walllist0";
			disablenpc instance_npcname("Dark Force#anightmare1");
			disablenpc instance_npcname("Dark Force#anightmare2");
			disablenpc instance_npcname("Dark Force#anightmare3");
			disablenpc instance_npcname("Dark Force#anightmare4");
			disablenpc instance_npcname("Dark Force#anightmare5");
			disablenpc instance_npcname("Dark Force#anightmare6");
			disablenpc instance_npcname("Dark Force#anightmare7");
			disablenpc instance_npcname("Dark Force#anightmare8");
			disablenpc instance_npcname("Dark Force#anightmare9");
			disablenpc instance_npcname("Dark Force#anightmare10");
			disablenpc instance_npcname("Dark Force#anightmare11");
			disablenpc instance_npcname("Dark Force#anightmare12");
			mapannounce 'second_map$,"Hera: Maybe next time.",bc_map,"0xFF0000",FW_NORMAL,12;
		}
	else{
		initnpctimer;
	}
	
OnTouch:
	if ('main_event == 4){
		areamonster 'second_map$,92,137,97,126,"Hera's Resentment",3410,12,instance_npcname("anightmare#2")+"::OnFakeHera";
		initnpctimer;
		//addtimer 500,instance_npcname("anightmare#2")+"::OnHeraTimer";
		set 'main_event,5;
	}
	end;
OnFakeHera:
	end;

	
OnGuardSpawn:
		set .@guard_spawn$,instance_npcname("anightmare#2")+"::OnGuardSpawn";
		if (mobcount('second_map$,.@guard_spawn$) < 1) {
			mapannounce 'second_map$,"Hera: You did good honey, have a cookie.",bc_map,"0xFF0000",FW_NORMAL,12;
			monster 'second_map$,122,16,"Hera's Resentment",3419,1;
			set 'hera_gid,$@mobid[0];
			initnpctimer;
			set 'main_event,7;
		}
		end;
		
	
OnHeraTimer2:
	mapannounce 'second_map$,"Hera: I'll make sure to not do that again.",bc_map,"0xFF0000",FW_NORMAL,12;
	end;
	
OnHeraTimer3:
	mapannounce 'second_map$,"Hera: Maybe If you defeat the Shadow Guards, I'll remove the wall, hmmmm.",bc_map,"0xFF0000",FW_NORMAL,12;
	end;

	
}
//mini boss fight
3@antgm,46,81,4	script	Lord of Hate#1	1219,{
	set .@party_id,getcharid(1);
	if (getcharid(0) != getpartyleader(.@party_id,2)) {
		end;
	}
	if ('main_event == 12){
		mes "[Lord of Hate]";
		mes "What are you doing here mortal?";
		npctalk "Lord of Hate: What are you doing here mortal?";
		select ("What are you doing to Alice?");
		unittalk 0,strcharinfo(0)+": What are you doing to Alice?";
		next;
		
		mes "[Lord of Hate]";
		mes "We consume soul as for you mortal consume flesh.";
		npctalk "Lord of Hate: We consume soul as for you mortal consume flesh.";
		next;
		
		mes "[Lord of Hate]";
		mes "And I will be the judge of your existence.";
		npctalk "Lord of Hate: And I will be the judge of your existence.";
		next;
		
		specialeffect 128;
		specialeffect 650;	
		mes "[Lord of Hate]";
		mes "Unfortunately, this is where your journey shall end.";
		npctalk "Lord of Hate: Unfortunately, this is where your journey shall end.";
		next;
		
		mes "[Lord of Hate]";
		mes "I will grant you eternal suffering without the right to death.";
		npctalk "Lord of Hate: I will grant you eternal suffering without the right to death.";
		close2;
		monster 'third_map$,46,81,"Lord of Hate",3404,1,instance_npcname("Lord of Hate#1")+"::OnLordDead";
		set 'lord_gid,$@mobid[0];
		disablenpc instance_npcname("Servent of Hate#1");
		disablenpc instance_npcname("Servent of Hate#2");
		disablenpc instance_npcname("gardenwarp#1");
		initnpctimer;
		set 'main_event,13;
		unitwarp getnpcid(0,instance_npcname("Lord of Hate#1")),'third_map$,5,3;
		//hideonnpc instance_npcname("Lord of Hate#1");
		end;
	}
	
OnTimer60000:
		
		if (unitexists('lord_gid)==0){
			stopnpctimer;
			end;}
		getunitdata 'lord_gid,.@test;
		if (.@test[UMOB_TARGETID] != 0){
			
			unittalk 'lord_gid,"Lord of Hate: Rise from the graves.";
			areamonster 'third_map$,(.@test[UMOB_X]-12),(.@test[UMOB_Y]-12),(.@test[UMOB_X]+12),(.@test[UMOB_Y]+12),"Undead Knight",3408,1,instance_npcname("Lord of Hate#1")+"::OnUndeadDead";
			areamonster 'third_map$,(.@test[UMOB_X]-12),(.@test[UMOB_Y]-12),(.@test[UMOB_X]+12),(.@test[UMOB_Y]+12),"Undead Knight",3409,1,instance_npcname("Lord of Hate#1")+"::OnUndeadDead";
		
		}
		
		end;
OnTimer120000:
	stopnpctimer;
	initnpctimer;
	end;
		
		
OnUndeadDead:
	end;
OnLordDead:
	set 'main_event,14;
	mapannounce 'third_map$,"Lord of Hate: What is the point of existence without hate?",bc_map,"0xFF0000",FW_NORMAL,12;
	enablenpc instance_npcname("gardenwarp#1");
	initnpctimer instance_npcname("gardenwarp#1");
	disablenpc instance_npcname("Dark Force#anightmare13");
	disablenpc instance_npcname("Dark Force#anightmare14");
	disablenpc instance_npcname("Dark Force#anightmare15");
	disablenpc instance_npcname("Dark Force#anightmare16");
	disablenpc instance_npcname("Dark Force#anightmare17");
	disablenpc instance_npcname("Dark Force#anightmare18");
	delwall 'second_map$+"anightmare_walllist2";
	delwall 'second_map$+"anightmare_walllist3";
	delwall 'second_map$+"anightmare_walllist4";
	delwall 'second_map$+"anightmare_walllist5";
	delwall 'second_map$+"anightmare_walllist6";
	delwall 'second_map$+"anightmare_walllist7";
	delwall 'second_map$+"anightmare_walllist8";
	delwall 'second_map$+"anightmare_walllist9";
	delwall 'second_map$+"anightmare_walllist10";
	delwall 'second_map$+"anightmare_walllist11";
	delwall 'second_map$+"anightmare_walllist12";
	delwall 'second_map$+"anightmare_walllist13";
	delwall 'second_map$+"anightmare_walllist14";
	delwall 'second_map$+"anightmare_walllist15";
	
	end;
}

//servent of hate npc
3@antgm,43,83,4	script	Servent of Hate#1	494,{
	mes "[Servent of Hate]";
	mes "Hatred, Pain, Anguish, Terror...";
	next;
	mes "[Servent of Hate]";
	mes "Those are all valid sentiments we all need to nurish.";
	close;
}
3@antgm,49,83,4	duplicate(Servent of Hate#1)	Servent of Hate#2	494


//map 3 interaction
3@antgm,1,1,4	script	anightmare#3	45,1,1,{
	end;
OnInstanceInit:
	//garden walls, there is a lot of them to prevent monsters from spawning on the other side during lord of hate fight
	setwall 'third_map$,43,86,6,6,0,'second_map$+"anightmare_walllist2";
	setwall 'third_map$,43,87,6,6,0,'second_map$+"anightmare_walllist3";
	setwall 'third_map$,43,88,6,6,0,'second_map$+"anightmare_walllist4";
	setwall 'third_map$,38,89,16,6,0,'second_map$+"anightmare_walllist5";
	setwall 'third_map$,38,90,16,6,0,'second_map$+"anightmare_walllist6";
	setwall 'third_map$,40,91,12,6,0,'second_map$+"anightmare_walllist7";
	setwall 'third_map$,40,92,12,6,0,'second_map$+"anightmare_walllist8";
	setwall 'third_map$,40,93,12,6,0,'second_map$+"anightmare_walllist9";
	setwall 'third_map$,40,94,12,6,0,'second_map$+"anightmare_walllist10";
	setwall 'third_map$,40,95,12,6,0,'second_map$+"anightmare_walllist11";
	setwall 'third_map$,40,96,12,6,0,'second_map$+"anightmare_walllist12";
	setwall 'third_map$,40,97,12,6,0,'second_map$+"anightmare_walllist13";
	setwall 'third_map$,40,98,12,6,0,'second_map$+"anightmare_walllist14";
	setwall 'third_map$,40,99,12,6,0,'second_map$+"anightmare_walllist15";
	//final walls just to force you to go in 1 direction temporarily
	setwall 'third_map$,190,182,14,6,0,'second_map$+"anightmare_walllist16";
	setwall 'third_map$,190,183,17,0,0,'second_map$+"anightmare_walllist17";
	setwall 'third_map$,203,183,17,0,0,'second_map$+"anightmare_walllist18";
	setwall 'third_map$,191,197,12,6,0,'second_map$+"anightmare_walllist19";
	end;
	
OnInstanceDestroy:
	delwall 'second_map$+"anightmare_walllist2";
	delwall 'second_map$+"anightmare_walllist3";
	delwall 'second_map$+"anightmare_walllist4";
	delwall 'second_map$+"anightmare_walllist5";
	delwall 'second_map$+"anightmare_walllist6";
	delwall 'second_map$+"anightmare_walllist7";
	delwall 'second_map$+"anightmare_walllist8";
	delwall 'second_map$+"anightmare_walllist9";
	delwall 'second_map$+"anightmare_walllist10";
	delwall 'second_map$+"anightmare_walllist11";
	delwall 'second_map$+"anightmare_walllist12";
	delwall 'second_map$+"anightmare_walllist13";
	delwall 'second_map$+"anightmare_walllist14";
	delwall 'second_map$+"anightmare_walllist15";
	
	delwall 'second_map$+"anightmare_walllist16";
	delwall 'second_map$+"anightmare_walllist17";
	delwall 'second_map$+"anightmare_walllist18";
	delwall 'second_map$+"anightmare_walllist19";
	end;
	

	

}

3@antgm,45,13,4	script	gardenwarp#1	45,1,1,{
	end;
OnTouch:
	warp 'second_map$,137,165;
	end;
OnTimer3500:
	mapannounce 'third_map$,"Lord of Hate: To defeat me is only to aknowledge your denial.",bc_map,"0xFF0000",FW_NORMAL,12;
	end;
OnTimer7000:
	mapannounce 'third_map$,"Lord of Hate: I live within everyone.",bc_map,"0xFF0000",FW_NORMAL,12;
	stopnpctimer;
	end;
}
2@antgm,137,162,4	script	insidewarp#4	45,1,1,{
	end;
OnTouch:
	warp 'third_map$,45,18;
	end;
}

//warp to Aline
2@antgm,174,81,4	script	insidewarp#2	45,1,1,{
		end;
OnTouch:
	if ('door_opened == 1){
		if ('aline_secret==1){
			playBGM "92";
		}
		warp 'second_map$,190,105;
		end;
	}
	if (countitem(7026) < 1 && countitem(7027) < 1){
		mes "The door is locked.";
		mes "If only I had brought a ^FF0000Key^000000.";
		close;
	}
	if (countitem(7026) > 0){
		set 'door_opened,1;
		mes "You unlocked the door with ^ff0000Key of Clock Tower^000000.";
		close2;
		delitem 7026,1;
		warp 'second_map$,190,105;
		end;
	}
		set 'door_opened,1;
		mes "You unlocked the door with ^ff0000Key of Underground^000000.";
		close2;
		delitem 7027,1;
		warp 'second_map$,190,105;
		end;
	
}

//warp out of aline
2@antgm,186,105,4	script	insidewarp#3	45,1,1,{
	end;
OnTouch:
	warp 'second_map$,170,81;
	end;
}



2@antgm,184,114,5	script	Aline#1		10191,{
	set .@party_id,getcharid(1);
	set .@aline_at,(anightmare_aline / 2);
	//only party leader engage the next part
	if (getcharid(0) != getpartyleader(.@party_id,2)) {
		cutin "ep16_evil102",1;
		mes "[Aline]";
		mes "Hi!";
		close2;
		cutin "",255;
		end;
	}
	//you lost the fight
	if ('aline_secret == 2){
		cutin "ep16_evil102",1;
		mes "[Aline]";
		mes "Oh man! What a thrill!";
		npctalk "Aline: Oh man! What a thrill!";
		next;
		if (.@aline_at >6){
			cutin "pops_lau",1;
			mes "[Seraph]";
			mes "Yay, We won!";
			npctalk ("Seraph: Yay, We won!",instance_npcname("Seraph#1"));
			next;
			cutin "ep16_evil102",1;
			mes "[Aline]";
			mes "We might aswell be the most powerful group in the world right now!";
			npctalk "Aline: We might aswell be the most powerful group in the world right now!";
			next;
			mes "[Aline]";
			mes "I guess we don't need training anymore.";
			npctalk "Aline: I guess we don't need training anymore.";
		}else{
			mes "[Aline]";
			mes "I might aswell be the most powerful person in the world right now!";
			npctalk "Aline: I might aswell be the most powerful person in the world right now!";
			next;
			mes "[Aline]";
			mes "I guess I don't need training anymore.";
			npctalk "Aline: I guess I don't need training anymore.";
		
		}
		


		next;
		mes "[Aline]";
		mes "You go and train, come back when you're stronger.";
		npctalk "Aline: You go and train, come back when you're stronger.";
		close2;
		disablenpc instance_npcname("Aline#1");
		disablenpc instance_npcname("Seraph#1");
		cutin "",255;
		end;
	}
	//won the fight
	if ('aline_secret == 3){
		if (.@aline_at >6){
			cutin "pops_lau",1;
			mes "[Seraph]";
			mes "That was fun!";
			npctalk ("Seraph: That was fun!",instance_npcname("Seraph#1"));
			next;
			
			cutin "ep16_evil103",1;
			mes "[Aline]";
			mes "But we lost.";
			npctalk "Aline: But we lost.";
			next;
			
			cutin "ep16_evil102",1;
			mes "[Aline]";
			mes "Oh well, come back later if you want to fight us again.";
			npctalk "Aline: Oh well, come back later if you want to fight us again.";
			close2;
		}else{
			cutin "ep16_evil103",1;
			mes "[Aline]";
			mes "Aw, I lost!";
			npctalk "Aline: Aw, I lost!";
			next;
			mes "[Aline]";
			mes "I'll need more training.";
			npctalk "Aline: I'll need more training.";
			next;
			mes "[Aline]";
			mes "Come back later, I'm off to practice some more.";
			npctalk "Aline: Come back later, I'm off to practice some more.";
			close2;
		}
		
		if (anightmare_aline - (.@aline_at * 2) == 1 && anightmare_aline < 16 && anightmare_aline > 2){
			anightmare_aline++;
			switch (anightmare_aline){
				case 4:
					/*Reward*/
					//First reward for defeating Aline
					//Can only be gotten once per character(easy)
					//Aline is a hidden boss with progressive difficulty within the instance.
					//Only the party leader can start or advance the quest
					//Everytime you come to the instance Aline gets more and more difficult
					//Due to the nature of the quest this will take days before 1 player get all reward
					getitem_map 6658,10,strcharinfo(3),1,getcharid(1);
					getexp_map 222222,222222,strcharinfo(3),1,getcharid(1);
					break;
				case 6:
					/*Reward*/
					//Second reward for defeating Aline
					//Can only be gotten once per character(normal)
					getitem_map 6658,15,strcharinfo(3),1,getcharid(1);
					getexp_map 277778,277778,strcharinfo(3),1,getcharid(1);
					break;
				case 8:
					/*Reward*/
					//Third reward for defeating Aline
					//Can only be gotten once per character(normal)
					getitem_map 6658,20,strcharinfo(3),1,getcharid(1);
					getexp_map 347222,347222,strcharinfo(3),1,getcharid(1);
					break;
				case 10:
					/*Reward*/
					//fourth reward for defeating Aline
					//Can only be gotten once per character(normal)
					getitem_map 6658,25,strcharinfo(3),1,getcharid(1);
					getexp_map 434027,434027,strcharinfo(3),1,getcharid(1);
					break;
				case 12:
					/*Reward*/
					//Fifth reward for defeating Aline
					//Can only be gotten once per character(hard)
					getitem_map 6658,30,strcharinfo(3),1,getcharid(1);
					getexp_map 542534,542534,strcharinfo(3),1,getcharid(1);
					break;
				case 14:
					/*Reward*/
					//Sixth reward for defeating Aline
					//Can only be gotten once per character(very hard)
					//case 14 happen only once but is basically the same as 16 so you can make this reward be given again and again or only once in case 14: or even 2 different reward
					//She has a minion when fighting her past 14 so there is a bit of an increased difficulty
					getitem_map 6658,35,strcharinfo(3),1,getcharid(1);
					getexp_map 678168,678168,strcharinfo(3),1,getcharid(1);
					break;
				case 16:
					//final reward if you do not wish for the reward to be given everytime
					//else use the check below
					break;


			}

		}
		if (anightmare_aline == 16){
			/*Reward*/
			//Final reward for defeating aline
			//setting a reward here will give you the reward everytime you defeat from this point on
			//if you want to give it only once use case 16 above instead.
			getitem_map 6658,40,strcharinfo(3),1,getcharid(1);
			getexp_map 847710,847710,strcharinfo(3),1,getcharid(1);
		}
		
		
		disablenpc instance_npcname("Aline#1");
		disablenpc instance_npcname("Seraph#1");
		cutin "",255;
		end;
	}
	
	//never talked to before
	if (anightmare_aline==0){
		cutin "ep16_evil102",1;
		mes "[Aline]";
		mes "Hi, I'm a student here.";
		npctalk "Aline: Hi, I'm a student here.";
		select ("This is not a School");
		unittalk 0,strcharinfo(0)+": This is not a School.";
		next;
		cutin "ep16_evil103",1;
		mes "[Aline]";
		mes "I said, I'm a student here!";
		npctalk "Aline: I said, I'm a student here!";
		select ("If you say so.");
		unittalk 0,strcharinfo(0)+": If you say so.";
		next;
		cutin "ep16_evil102",1;
		mes "[Aline]";
		mes "I'm learning the Art of Fighting.";
		npctalk "Aline: I'm learning the Art of Fighting.";
		next;
		cutin "",255;
		cutin "ep16_evil101",1;
		mes "[Aline]";
		mes "The problem is I got nobody to fight with.";
		npctalk "Aline: The problem is I got nobody to fight with.";
		switch (select ("Fight your enemies:Fight monsters")){
			case 1:
				unittalk 0,strcharinfo(0)+": Fight your enemies.";
				next;
				mes "[Aline]";
				mes "Enemies? I don't have enemies, everyone is my friend.";
				npctalk "Aline: Enemies? I don't have enemies, everyone is my friend.";
				break;
			case 2:
				unittalk 0,strcharinfo(0)+": Fight monsters.";
				next;
				mes "[Aline]";
				mes "No! The monsters here are my friends.";
				npctalk "Aline: No! The monsters here are my friends.";
				break;
		}
		next;
		cutin "ep16_evil102",1;
		mes "[Aline]";
		mes "Here is an idea.";
		npctalk "Aline: Here is an idea.";
		next;
		mes "[Aline]";
		mes "Become my BFF.";
		npctalk "Aline: Become my BFF.";
		select ("Best Friend Forever?");
		unittalk 0,strcharinfo(0)+": Best Friend Forever?";
		next;
		mes "[Aline]";
		mes "No, Best Fighting Friends.";
		npctalk "Aline: No, Best Fighting Friends.";
		next;
		mes "[Aline]";
		mes "Friends that only fight each other.";
		npctalk "Aline: Friends that only fight each other.";
		select ("Those are called enemies");
		unittalk 0,strcharinfo(0)+": Those are called enemies.";
		next;
		mes "[Aline]";
		mes "Enemies hate each other, we don't need to.";
		npctalk "Aline: Enemies hate each other, we don't need to.";
		next;
		mes "[Aline]";
		mes "You can come visit me from time to time.";
		npctalk "Aline: You can come visit me from time to time.";
		next;
		mes "[Aline]";
		mes "We can fight and you can see how much progress I'm doing.";
		npctalk "Aline: We can fight and you can see how much progress I'm doing.";
		next;
		mes "[Aline]";
		mes "What do you say?";
		npctalk "Aline: What do you say?";
		switch (select ("Sure, Let's do it!:Too Dangerous")){
			case 1:
				set anightmare_aline,2;
				unittalk 0,strcharinfo(0)+": Sure let's do it.";
				next;
				cutin "ep16_evil102",1;
				mes "[Aline]";
				mes "Awesome! Let me know when you want to fight me.";
				npctalk "Aline: Awesome! Let me know when you want to fight me.";
				break;
			case 2:
				set anightmare_aline,1;
				unittalk 0,strcharinfo(0)+": Too Dangerous.";
				next;
				cutin "ep16_evil101",1;
				mes "[Aline]";
				mes "That's a bummer... And I thought I had finally found someone to fight with.";
				npctalk "Aline: That's a bummer... And I thought I had finally found someone to fight with.";
				next;
				mes "[Aline]";
				mes "Well... Come back if you change your mind.";
				npctalk "Aline: Well... Come back if you change your mind.";
				break;
		
		}
		close2;
		cutin "",255;
		end;
	}
	//talked but refused
	if (anightmare_aline==1){
			cutin "ep16_evil102",1;
			mes "[Aline]";
			mes "Hi again.";
			npctalk "Aline: Hi again.";
			next;
			mes "[Aline]";
			mes "Have you changed your mind?";
			npctalk "Aline: Have you changed your mind?";
			
			switch (select ("Yes:Nope")){
				case 1:
				
					set anightmare_aline,2;
					unittalk 0,strcharinfo(0)+": Yes.";
					next;
					mes "[Aline]";
					mes "Awesome! Let me know when you want to fight me.";
					npctalk "Aline: Awesome! Let me know when you want to fight me.";
					break;
				case 2:
					unittalk 0,strcharinfo(0)+": Nope.";
					next;
					mes "[Aline]";
					mes "Oh well.";
					npctalk "Aline: Oh well.";
					break;
			
			}
			close2;
			cutin "",255;
			end;
	}
	
	switch (.@aline_at){
		case 0:
			end;
		case 1:
			cutin "ep16_evil102",1;
			mes "[Aline]";
			mes "Just to let you know I'm closing the door while we are fighting.";
			npctalk "Aline: Just to let you know I'm closing the door while we are fighting.";
			next;
			break;
		case 2:
			cutin "ep16_evil102",1;
			mes "[Aline]";
			mes "We meet again!";
			npctalk "Aline: We meet again!";
			next;
			mes "[Aline]";
			mes "I thought about our previous fight a lot.";
			npctalk "Aline: I thought about our previous fight a lot.";
			select ("What did you learn?");
			unittalk 0,strcharinfo(0)+": What did you learn?";
			next;
			mes "[Aline]";
			mes "I felt very weak compare to you.";
			npctalk "Aline: I felt very weak compare to you.";
			next;
			mes "[Aline]";
			mes "I decided to seek help from a great beast in the desert.";
			npctalk "Aline: I decided to seek help from a great beast in the desert.";
			next;
			mes "[Aline]";
			mes "When I met him, I understood.";
			npctalk "Aline: When I met him, I understood.";
			select ("What is it?");
			unittalk 0,strcharinfo(0)+": What is it?";
			next;
			mes "[Aline]";
			mes "I needed more strenght!";
			npctalk "Aline: I needed more strenght!";
			next;
			mes "[Aline]";
			mes "I might be too small to chop a mountain in half like he does.";
			npctalk "Aline: I might be too small to chop a mountain in half like he does.";
			next;
			mes "[Aline]";
			mes "But I can compact the same amount of strenght in a smaller area.";
			npctalk "Aline: But I can compact the same amount of strenght in a smaller area.";
			next;
			mes "[Aline]";
			mes "So I went through rigurous training and learned from him.";
			npctalk "Aline: So I went through rigurous training and learned from him.";
			next;
			mes "[Aline]";
			mes "Now I feel confident that I can win!";
			npctalk "Aline: Now I feel confident that I can win!";
			next;
			break;
		case 3:
			cutin "ep16_evil102",1;
			mes "[Aline]";
			mes "You're back!";
			npctalk "Aline: You're back!";
			next;
			cutin "ep16_evil101",1;
			mes "[Aline]";
			mes "I thought you were not going to come back after last time.";
			npctalk "Aline: I thought you were not going to come back after last time.";
			select ("Why is that?");
			unittalk 0,strcharinfo(0)+": Why is that?";
			next;
			mes "[Aline]";
			mes "Because I'm too weak.";
			npctalk "Aline: Because I'm too weak.";
			select ("You just started learning");
			unittalk 0,strcharinfo(0)+": You just started learning.";
			next;
			mes "[Aline]";
			mes "That's true.";
			npctalk "Aline: That's true.";
			next;
			mes "[Aline]";
			mes "But your defence was just too high.";
			npctalk "Aline: But your defence was just too high.";
			next;
			mes "[Aline]";
			mes "My attacks didn't do anything.";
			npctalk "Aline: My attacks didn't do anything.";
			next;
			mes "[Aline]";
			mes "But what can you do against Defence?";
			npctalk "Aline: But what can you do against Defence?";
			next;
			mes "[Aline]";
			mes "The Monks do this technic that does higher damage if you have higher defence.";
			npctalk "Aline: The Monks do this technic that does higher damage if you have higher defence.";
			next;
			mes "[Aline]";
			mes "But it's too easy to have no defence versus having high defence.";
			npctalk "Aline: But it's too easy to have no defence versus having high defence.";
			next;
			mes "[Aline]";
			mes "So, that's counter productive.";
			npctalk "Aline: So, that's counter productive.";
			next;
			mes "[Aline]";
			mes "Instead, I've looked into attacks that ignore defence.";
			npctalk "Aline: Instead, I've looked into attacks that ignore defence.";
			next;
			mes "[Aline]";
			mes "I think with these new tricks up my sleeves, I can defeat you.";
			npctalk "Aline: I think with these new tricks up my sleeves, I can defeat you.";
			next;
			break;
		case 4:
			cutin "ep16_evil101",1;
			mes "[Aline]";
			mes "I understand now!";
			npctalk "Aline: I understand now!";
			select ("What?");
			unittalk 0,strcharinfo(0)+": What?";
			next;
			mes "[Aline]";
			mes "The problem is not that I'm weak!";
			npctalk "Aline: The problem is not that I'm weak!";
			
			next;
			mes "[Aline]";
			mes "It's that I rely too much on Strenght alone.";
			npctalk "Aline: It's that I rely too much on Strenght alone.";
			
			next;
			mes "[Aline]";
			mes "I saw this group of adventurers at the church getting Annihilated.";
			npctalk "Aline: I saw this group of adventurers at the church getting Annihilated.";
			
			next;
			mes "[Aline]";
			mes "Because their enemies were weakening them so much.";
			npctalk "Aline: Because their enemies were weakening them so much.";
			
			next;
			mes "[Aline]";
			mes "What can your enemy do if you stop them dead on their track.";
			npctalk "Aline: What can your enemy do if you stop them dead on their track.";
			
			next;
			mes "[Aline]";
			mes "I've researched various weakened states that one can deal with.";
			npctalk "Aline: I've researched various weakened states that one can deal with.";		
	
			next;
			mes "[Aline]";
			mes "And I'm very eager to try this out!";
			npctalk "Aline: And I'm very eager to try this out!";
			next;
			break;
			
		case 5:
			cutin "ep16_evil101",1;
			mes "[Aline]";
			mes "I feel really defeated.";
			npctalk "Aline: I feel really defeated.";
			select ("You're improving");
			unittalk 0,strcharinfo(0)+": You're improving.";
			
			next;
			mes "[Aline]";
			mes "You don't understand.";
			npctalk "Aline: You don't understand.";
			
			next;
			mes "[Aline]";
			mes "I've been learning the wrong things all along.";
			npctalk "Aline: I've been learning the wrong things all along.";
			select ("Is that so?");
			unittalk 0,strcharinfo(0)+": Is that so?";
			
			next;
			mes "[Aline]";
			mes "Yes, I saw this magician destroy an entire army by casting a giant storm of thunder, fire and ice over them.";
			npctalk "Aline: Yes, I saw this magician destroy an entire army by casting a giant storm of thunder, fire and ice over them.";
			
			next;
			mes "[Aline]";
			mes "I thought... What can my puny Scythe do against that?";
			npctalk "Aline: I thought... What can my puny Scythe do against that?";
			
			next;
			mes "[Aline]";
			mes "If I had been in that army, I would not have made any difference.";
			npctalk "Aline: If I had been in that army, I would not have made any difference.";
			
			next;
			mes "[Aline]";
			mes "But, I can't remain defeated!";
			npctalk "Aline: But, I can't remain defeated!";
			
			next;
			mes "[Aline]";
			mes "So, I studied magic!";
			npctalk "Aline: So, I studied magic!";
			
			next;
			mes "[Aline]";
			mes "It's harder then I thought but...";
			npctalk "Aline: It's harder then I thought but...";
			
			next;
			mes "[Aline]";
			mes "I've made great progress and I'm ready to put it to the test!";
			npctalk "Aline: I've made great progress and I'm ready to put it to the test!";
			next;
			break;
			
		case 6:
			cutin "ep16_evil101",1;
			mes "[Aline]";
			mes "I think, I've reached a peak.";
			npctalk "Aline: I think, I've reached a peak.";
			select ("You are pretty tough now");
			unittalk 0,strcharinfo(0)+": You are pretty tough now";
			next;

			mes "[Aline]";
			mes "All I need to do now is own my skills.";
			npctalk "Aline: All I need to do now is own my skills.";
			next;
			
			mes "[Aline]";
			mes "I've learned a lot from all our fights.";
			npctalk "Aline: I've learned a lot from all our fights.";
			next;
			mes "[Aline]";
			mes "I just need to put it all together and strategies more.";
			npctalk "Aline: I just need to put it all together and strategies more.";
			next;
			break;
			
		case 7:
			cutin "ep16_evil102",1;
			mes "[Aline]";
			mes "Hey!";
			npctalk "Aline: Hey!";
			next;
			
			mes "[Aline]";
			mes "I've made a new friend!";
			npctalk "Aline: I've made a new friend!";
			next;
			enablenpc  instance_npcname("Seraph#1");
			set 'seraphon,1;
			cutin "pops_lau",1;
			mes "[Seraph]";
			mes "Hi!";
			npctalk ("Seraph: Hi!",instance_npcname("Seraph#1"));
			select ("Wow, where did you come from?");
			unittalk 0,strcharinfo(0)+": Wow, where did you come from?";
			next;
			cutin "ep16_evil102",1;
			mes "[Aline]";
			mes "She will be assisting me in battle.";
			npctalk "Aline: She will be assisting me in battle.";
			next;
			break;
			
		case 8:
			cutin "ep16_evil102",1;
			enablenpc  instance_npcname("Seraph#1");
			set 'seraphon,1;
			mes "[Aline]";
			mes "You came to see us again.";
			npctalk "Aline: You came to see us again.";
			next;
			break;
			
	}
	//accepted but never fought.
			
			mes "[Aline]";
			mes "So, Are you ready?";
			npctalk "Aline: So, Are you ready?";
			switch (select("Let's go!:Maybe later")){
				case 1:
					unittalk 0,strcharinfo(0)+": Let's go!";
					playBGMall "92",'second_map$,179,120,192,107;
					next;
					mes "[Aline]";
					mes "Alright, here I come!";
					npctalk "Aline: Alright, here I come!";
					close2;
					
					set 'aline_secret,1;
					if (anightmare_aline - (.@aline_at * 2) == 0 && anightmare_aline < 16 && anightmare_aline > 1){
						anightmare_aline++;
					}
					
					if (anightmare_aline>15){
						monster 'second_map$,184,114,"Aline",3417,1,instance_npcname("Aline#1")+"::OnAlineDead";
					}else{
						monster 'second_map$,184,114,"Aline",(3410 + .@aline_at),1,instance_npcname("Aline#1")+"::OnAlineDead";
					}
					set 'aline_gid,$@mobid[0];
					hideonnpc instance_npcname("Aline#1");
					disablenpc  instance_npcname("insidewarp#3");
					disablenpc  instance_npcname("Seraph#1");
					cutin "",255;
					set 'notarget,0;
					initnpctimer;
					end;
				case 2:
					unittalk 0,strcharinfo(0)+": Maybe later.";
					mes "[Aline]";
					mes "Alright, no pressure.";
					npctalk "Aline: Alright, no pressure.";
					close2;
					cutin "",255;
					end;
			}
	

//remove Aline if she has no target for an extended period of time.
OnTimer1000:
	getunitdata 'aline_gid,.@test;
	playBGMall "92",'second_map$,179,120,192,107;
	if (.@test[UMOB_TARGETID] == 0){
		'notarget++;
		if ('notarget >10){
			set 'aline_secret,2;
			unitwarp 'aline_gid,'second_map$,40,179;
			unitkill 'aline_gid;
			set 'aline_secret,2;
			stopnpctimer;
			end;
		}
	}else{
		set 'notarget,0;
	}
	initnpctimer;
	end;
	
OnAlineDead:
	if ('aline_secret == 1){
		set 'aline_secret,3;
	}
	playBGMall "107",'second_map$,179,120,192,107;
	stopnpctimer;
	enablenpc  instance_npcname("insidewarp#3");
	hideoffnpc instance_npcname("Aline#1");
	if ('seraphon == 1){
		enablenpc  instance_npcname("Seraph#1");
	}
	end;
}

2@antgm,185,116,4	script	Seraph#1	10173,{
		mes "[Seraph]";
		mes "...";
		close;
	OnInstanceInit:
		disablenpc  instance_npcname("Seraph#1");
		end;

}


//barricades visual effect
2@antgm,127,19,0	script	Dark Force#anightmare1	10045,{
	
	if ('main_event == 11){
		set .@party_id,getcharid(1);
		if (getcharid(0) != getpartyleader(.@party_id,2)) {
			end;
		}
		mes "You used the stone on the barrier.";
		next;
		specialeffect 59;
		specialeffect 108;
		specialeffect 702;
		mes "";
		next;
		specialeffect 62;
		mes "";
		next;
		specialeffect 90;
		specialeffect 99;
		mes "";
		next;
		specialeffect 108;
		disablenpc instance_npcname("Dark Force#anightmare19");
		disablenpc instance_npcname("Dark Force#anightmare20");
		disablenpc instance_npcname("Dark Force#anightmare21");
		disablenpc instance_npcname("Dark Force#anightmare22");
		disablenpc instance_npcname("Dark Force#anightmare23");
		disablenpc instance_npcname("Dark Force#anightmare24");
		delwall 'second_map$+"anightmare_walllist1";
		monster ('third_map$,45,31,"Shadow of Hate",3403,1,"");
		monster ('third_map$,38,25,"Shadow of Hate",3403,1,"");
		monster ('third_map$,53,25,"Shadow of Hate",3403,1,"");
		set 'main_event,12;
	}
	end;
	}
2@antgm,127,18,0	duplicate(Dark Force#anightmare1)	Dark Force#anightmare2	10042
2@antgm,127,17,0	duplicate(Dark Force#anightmare1)	Dark Force#anightmare3	10045
2@antgm,127,16,0	duplicate(Dark Force#anightmare1)	Dark Force#anightmare4	10042
2@antgm,127,15,0	duplicate(Dark Force#anightmare1)	Dark Force#anightmare5	10045
2@antgm,127,14,0	duplicate(Dark Force#anightmare1)	Dark Force#anightmare6	10042
2@antgm,127,13,0	duplicate(Dark Force#anightmare1)	Dark Force#anightmare7	10045
2@antgm,127,12,0	duplicate(Dark Force#anightmare1)	Dark Force#anightmare8	10042
2@antgm,127,18,0	duplicate(Dark Force#anightmare1)	Dark Force#anightmare9	723
2@antgm,127,16,0	duplicate(Dark Force#anightmare1)	Dark Force#anightmare10	723
2@antgm,127,14,0	duplicate(Dark Force#anightmare1)	Dark Force#anightmare11	723
2@antgm,127,12,0	duplicate(Dark Force#anightmare1)	Dark Force#anightmare12	723

2@antgm,132,176,0	duplicate(Dark Force#anightmare1)	Dark Force#anightmare19	10042
2@antgm,132,175,0	duplicate(Dark Force#anightmare1)	Dark Force#anightmare20	10045
2@antgm,132,174,0	duplicate(Dark Force#anightmare1)	Dark Force#anightmare21	10042
2@antgm,132,173,0	duplicate(Dark Force#anightmare1)	Dark Force#anightmare22	10045
2@antgm,132,175,0	duplicate(Dark Force#anightmare1)	Dark Force#anightmare23	723
2@antgm,132,173,0	duplicate(Dark Force#anightmare1)	Dark Force#anightmare24	723

3@antgm,43,87,0	duplicate(Dark Force#anightmare1)	Dark Force#anightmare13	10045
3@antgm,44,87,0	duplicate(Dark Force#anightmare1)	Dark Force#anightmare14	10042
3@antgm,45,87,0	duplicate(Dark Force#anightmare1)	Dark Force#anightmare15	10045
3@antgm,46,87,0	duplicate(Dark Force#anightmare1)	Dark Force#anightmare16	10042
3@antgm,47,87,0	duplicate(Dark Force#anightmare1)	Dark Force#anightmare17	10045
3@antgm,48,87,0	duplicate(Dark Force#anightmare1)	Dark Force#anightmare18	10042


2@antgm,116,182,0	script	Piano#anightmare1	111,{
	if ('main_event !=9){
		end;
	}

	if ('piano_got == 0){
		mes "You try to remove a key from the piano";
		next;
		mes ".";
		next;
		mes "..";
		next;
		mes "...";
		next;
		if (rand(1,10)==1){
			mes "The key came off without breaking.";
			set 'piano_got,getcharid(0);
			mapannounce 'second_map$, strcharinfo(0) +" got a Piano Key.",bc_map,"0x00ff99",FW_NORMAL,12;
			close;
		}else{
			mes "The key broke off, try another one.";
			close;
		}
	}
	mes "We Already got a Piano Key.";
	close;

}

2@antgm,166,95,0	script	Herb Stack#anightmare1	111,{
	if ('main_event !=9){
		end;
	}

	if ('herb_got == 0){
			mes "You picked up the finest herb you could find.";
			set 'herb_got,getcharid(0);
			mapannounce 'second_map$, strcharinfo(0) +" got Finest Herb.",bc_map,"0x00ff99",FW_NORMAL,12;
			close;
	}
	mes "We Already got the herb.";
	close;

}

2@antgm,83,102,0	script	Book Shelves#anightmare1	111,{
	if ('main_event !=9){
		end;
	}

	if ('book_got == 0){
			mes "You picked up the Book of Hate.";
			mes "You suddenly feel very weak.";
			set 'book_got,getcharid(0);
			mapannounce 'second_map$, strcharinfo(0) +" got Book of Hate.",bc_map,"0x00ff99",FW_NORMAL,12;
			percentheal -95,-100;
			sc_start SC_CURSE,20000,0;
			close;
	}
	mes "We Already got the book.";
	close;
}

2@antgm,45,182,0	script	Crystal#anightmare1	10045,5,5,{
	if ('main_event !=9){
		end;
	}
	if ('crystal_got == 0){
			mes "A crystal structure formed where the monster came from.";
			next;
			mes "You got Crystal of Hate.";
			set 'crystal_got,getcharid(0);
			mapannounce 'second_map$, strcharinfo(0) +" got Crystal of Hate.",bc_map,"0x00ff99",FW_NORMAL,12;
			percentheal -95,-100;
			sc_start SC_CURSE,20000,0;
			disablenpc instance_npcname("Crystal#anightmare1");
			close;
	}
	end;


OnTouch:
	if ('main_event !=9){
		end;
	}
	if ('touch_crystal == 0){
		set 'touch_crystal,1;
		set .@crystal_spawn$,instance_npcname("Crystal#anightmare1")+"::OnCrystalSpawn";
		areamonster 'second_map$,40,187,50,176,"Remenent of Hate",3401,5,.@crystal_spawn$;
		areamonster 'second_map$,40,187,50,176,"Carrier of Hate",3402,3,.@crystal_spawn$;
		areamonster 'second_map$,40,187,50,176,"Shadow of Hate",3403,2,.@crystal_spawn$;
		mapannounce 'second_map$,"Hera: I didn't do that! You walked into that one on your own.",bc_map,"0xFF0000",FW_NORMAL,12;
	
	}
	end;
	
OnCrystalSpawn:
	set .@crystal_spawn$,instance_npcname("Crystal#anightmare1")+"::OnCrystalSpawn";
	if (mobcount('second_map$,.@crystal_spawn$) < 1) {
		if ('touch_crystal == 1){
			set 'touch_crystal,2;
			areamonster 'second_map$,40,187,50,176,"Remenent of Hate",3401,2,.@crystal_spawn$;
			areamonster 'second_map$,40,187,50,176,"Carrier of Hate",3402,2,.@crystal_spawn$;
			areamonster 'second_map$,40,187,50,176,"Shadow of Hate",3403,3,.@crystal_spawn$;
			end;
		}
		if ('touch_crystal == 2){
			hideoffnpc instance_npcname("Crystal#anightmare1");
		}
	}
	end;

OnInstanceInit:
	hideonnpc instance_npcname("Crystal#anightmare1");
	end;
}

2@antgm,147,33,0	script	Bottle of Liquids#anightmare1	111,{
	if ('main_event !=9){
		end;
	}

	if ('bottle_got == 0){
			mes "You picked up a Bottle of Liquid.";
			set 'bottle_got,getcharid(0);
			mapannounce 'second_map$, strcharinfo(0) +" got Bottle of Liquid.",bc_map,"0x00ff99",FW_NORMAL,12;
			close;
	}
	mes "We already got the Bottle of Liquid.";
	close;
}

2@antgm,153,24,3	script	Dead Magician#anightmare1	792,{
		set .@party_id,getcharid(1);
		set .@char_id,getcharid(0);
		//deliver bottle
		if (.@char_id == 'bottle_got){
			mes "[Dead Mage]";
			mes "Oh yeah! The Bottles were right there, silly me!";
			npctalk "Dead Mage: Oh yeah! The Bottles were right there, silly me!";
			mapannounce 'second_map$, strcharinfo(0) +" delivered the Bottle of Liquid.",bc_map,"0x00ff99",FW_NORMAL,12;
			set 'bottle_got,-1;
			if (.@char_id == 'herb_got || .@char_id == 'piano_got || .@char_id == 'book_got || .@char_id == 'crystal_got){
				next;
				mes "[Dead Mage]";
				mes "Anything else?";
				npctalk "Dead Mage: Anything else?";
				next;
			}else{
				close;
			}
		}
		if (.@char_id == 'herb_got){
			mes "[Dead Mage]";
			mes "Those are barely fine herbs, but that will do.";
			npctalk "Dead Mage: Those are barely fine herbs, but that will do.";
			mapannounce 'second_map$, strcharinfo(0) +" delivered the Finest Herb.",bc_map,"0x00ff99",FW_NORMAL,12;
			set 'herb_got,-1;
			if (.@char_id == 'piano_got || .@char_id == 'book_got || .@char_id == 'crystal_got){
				next;
				mes "[Dead Mage]";
				mes "Got more?";
				npctalk "Dead Mage: Got more?";
				next;
			}else{
				close;
			}
		}
		if (.@char_id == 'piano_got){
			mes "[Dead Mage]";
			mes "A Piano Key!";
			npctalk "Dead Mage: A Piano Key!";
			mapannounce 'second_map$, strcharinfo(0) +" delivered the Piano Key.",bc_map,"0x00ff99",FW_NORMAL,12;
			set 'piano_got,-1;
			if (.@char_id == 'book_got || .@char_id == 'crystal_got){
				next;
				mes "[Dead Mage]";
				mes "What else?";
				npctalk "Dead Mage: What else?";
				next;
			}else{
				close;
			}
		}
		if (.@char_id == 'book_got){
			mes "[Dead Mage]";
			mes "Sorry for asking you to carry this book, it must have been painful.";
			npctalk "Dead Mage: Sorry for asking you to carry this book, it must have been painful.";
			mapannounce 'second_map$, strcharinfo(0) +" delivered the Book of Hate.",bc_map,"0x00ff99",FW_NORMAL,12;
			set 'book_got,-1;
			if (.@char_id == 'crystal_got){
				next;
				mes "[Dead Mage]";
				mes "Got any more?";
				npctalk "Dead Mage: Got any more?";
				next;
			}else{
				close;
			}
		}
		if (.@char_id == 'crystal_got){
			mes "[Dead Mage]";
			mes "Hey you've found one. this one is good.";
			npctalk "Dead Mage: Hey you've found one. this one is good.";
			mapannounce 'second_map$, strcharinfo(0) +" delivered the Crystal of Hate.",bc_map,"0x00ff99",FW_NORMAL,12;
			set 'crystal_got,-1;
			next;
			mes "[Dead Mage]";
			mes "Not that I didn't beleive you would but...";
			npctalk "Dead Mage: Not that I didn't beleive you would but...";
			close;
		}
		
	if (getcharid(0) != getpartyleader(.@party_id,2)) {
		mes "...";
		close;
	}
	if ('main_event == 8){
		if (anightmare_wakeup == 3){
			mes "^FF0000System message^000000";
			mes "Do you wish to skip this Dialogue?";
			next;
			if (select("No:Yes") == 2){
				set 'main_event,9;
				monster ('second_map$,112,179,"Shadow of Hate",3403,1,"");
				monster ('second_map$,119,179,"Shadow of Hate",3403,1,"");
				mapannounce 'second_map$, "Hera: Yay, Fetch quest!",bc_map,"0xff0000",FW_NORMAL,12;
				npctalk "Dead Mage: She's at it again.";
				close;
			}
			
		}
		mes "[Dead Mage]";
		mes "I've never seen you around here.";
		npctalk "Dead Mage: I've never seen you around here.";
		next;
		
		mes "[Dead Mage]";
		mes "What business could you have around here.";
		npctalk "Dead Mage: What business could you have around here.";
		select ("Have you seen...");
		unittalk 0,strcharinfo(0)+": Have you seen a girl with blue hair and dress?";
		next;
		
		mes "[Dead Mage]";
		mes "Ahhh! So, that's why you're here.";
		npctalk "Dead Mage: Ahhh! So, that's why you're here.";
		select ("So, you've seen her?");
		unittalk 0,strcharinfo(0)+": So, you've seen her?";
		next;
		
		mes "[Dead Mage]";
		mes "No, but I know where she might be.";
		npctalk "Dead Mage: No, but I know where she might be.";
		select ("Where is that?");
		unittalk 0,strcharinfo(0)+": Where is that?";
		next;
		
		mes "[Dead Mage]";
		mes "You will have to go through the garden.";
		npctalk "Dead Mage: You will have to go through the garden.";
		next;
		
		mes "[Dead Mage]";
		mes "But the access to reach there is probably blocked.";
		npctalk "Dead Mage: But the access to reach there is probably blocked.";
		next;
		
		mes "[Dead Mage]";
		mes "You will have to remove the magic barrier.";
		npctalk "Dead Mage: You will have to remove the magic barrier.";
		select ("How can we do that?");
		unittalk 0,strcharinfo(0)+": How can we do that?";
		next;
		
		mes "[Dead Mage]";
		mes "You will need a Magic Breaker Stone.";
		npctalk "Dead Mage: You will need a Magic Breaker Stone.";
		select ("Where can I get that?");
		unittalk 0,strcharinfo(0)+": Where can I get that?";
		next;
		
		mes "[Dead Mage]";
		mes "I can make it for you.";
		npctalk "Dead Mage: I can make it for you.";
		next;
		
		mes "[Dead Mage]";
		mes "You will need to fetch what I need for it though.";
		npctalk "Dead Mage: You will need to fetch what I need for it though";
		select ("What do you need?");
		unittalk 0,strcharinfo(0)+": What do you need?";
		next;
		
		mes "[Dead Mage]";
		mes "The objects I need are around the mansion here somewhere.";
		npctalk "Dead Mage: The objects I need are around the mansion here somewhere.";
		next;
		
		mes "[Dead Mage]";
		mes "I will need the Book of Hate for the Incantation.";
		npctalk "Dead Mage: I will need the Book of Hate for the Incantation.";
		next;
		
		mes "[Dead Mage]";
		mes "It should be in the Book Shelves in the guest rooms.";
		npctalk "Dead Mage: It should be in the Book Shelves in the guest rooms.";
		next;
		
		mes "[Dead Mage]";
		mes "Also need the Finest Herb you can find.";
		npctalk "Dead Mage: Also need the Finest Herb you can find.";
		next;
		
		mes "[Dead Mage]";
		mes "There should be some herb in a box somewhere.";
		npctalk "Dead Mage: There should be some herb in a box somewhere.";
		next;
		
		mes "[Dead Mage]";
		mes "A Piano key, a Bottle of Liquid and Crystal of Hate.";
		npctalk "Dead Mage: A Piano key, a Bottle of Liquid and Crystal of Hate.";
		next;
		
		mes "[Dead Mage]";
		mes "The Piano Key should be obvious and the rest I'm not too sure.";
		npctalk "Dead Mage: The Piano Key should be obvious and the rest I'm not too sure.";
		next;
		
		mes "[Dead Mage]";
		mes "Just look around the mansion, You should find them eventually.";
		npctalk "Dead Mage: Just look around the mansion, You should find them eventually.";
		close2;
		set 'main_event,9;
		monster ('second_map$,112,179,"Shadow of Hate",3403,1,"");
		monster ('second_map$,119,179,"Shadow of Hate",3403,1,"");
		mapannounce 'second_map$, "Hera: Yay, Fetch quest!",bc_map,"0xff0000",FW_NORMAL,12;
		npctalk "Dead Mage: She's at it again.";
		end;
		
	}
	
	if ('main_event == 9){
		set .@item_count,5;
		if ('book_got == -1){.@item_count--;}
		if ('bottle_got == -1){.@item_count--;}
		if ('piano_got == -1){.@item_count--;}
		if ('herb_got == -1){.@item_count--;}
		if ('crystal_got == -1){.@item_count--;}
		if (.@item_count != 0){
			set .@how_many,0;
			mes "[Dead Mage]";
			set .@message$,"Still need";
			if ('book_got != -1){
				set .@message$,.@message$+" the Book of Hate";
				.@item_count--;
				.@how_many++;
			}
			if ('bottle_got != -1){
				if (.@how_many != 0){if (.@item_count == 1){set .@message$,.@message$+" and";}else{set .@message$,.@message$+",";}}
				set .@message$,.@message$+" a Bottle of Liquid";
				.@item_count--;
				.@how_many++;
			}
			if ('piano_got != -1){
				if (.@how_many != 0){if (.@item_count == 1){set .@message$,.@message$+" and";}else{set .@message$,.@message$+",";}}
				set .@message$,.@message$+" a Piano Key";
				.@item_count--;
				.@how_many++;
			}
			if ('herb_got != -1){
				if (.@how_many != 0){if (.@item_count == 1){set .@message$,.@message$+" and";}else{set .@message$,.@message$+",";}}
				set .@message$,.@message$+" Finest Herb";
				.@item_count--;
				.@how_many++;
			}
			if ('crystal_got != -1){
				if (.@how_many != 0){if (.@item_count == 1){set .@message$,.@message$+" and";}else{set .@message$,.@message$+",";}}
				set .@message$,.@message$+" Crystal of Hate";
				.@item_count--;
				.@how_many++;
			}
			mes .@message$+".";
			npctalk "Dead Mage: "+.@message$+".";
			close;
		
		
		}else{
			mes "[Dead Mage]";
			mes "You got everything.";
			npctalk "Dead Mage: You got everything.";
			next;
			
			mes "[Dead Mage]";
			mes "Alright, Give me a few minutes.";
			npctalk "Dead Mage: Alright, Give me a few minutes.";
			set 'main_event,10;
			close;
			
		}
	
	}
	if ('main_event == 10){
	
		if (anightmare_wakeup == 3){
			mes "^FF0000System message^000000";
			mes "Do you wish to skip this Dialogue?";
			next;
			if (select("No:Yes") == 2){
				mes "You got Magic Breaker Stone.";
				disablenpc instance_npcname("Dead Magician#anightmare1");
				mapannounce 'second_map$, strcharinfo(0) +" got Magic Breaker Stone.",bc_map,"0x00ff99",FW_NORMAL,12;
				set 'main_event,11;
				close;
			}
			
		}
		
		mes "[Dead Mage]";
		mes "Just give me a moment please.";
		npctalk "Just give me a moment please.";
		select ("What's going on here?");
		unittalk 0,strcharinfo(0)+": What's going on here?";
		next;
		
		mes "[Dead Mage]";
		mes "Oh nothing, Just Hera playing games to torment the deads again.";
		npctalk "Dead Mage: Oh nothing, Just Hera playing games to torment the deads again.";
		select ("We're not dead.");
		unittalk 0,strcharinfo(0)+": We're not dead.";
		next;
		
		mes "[Dead Mage]";
		mes "This is Hollowtown, You gotta be dead to be here.";
		select ("We came through the Yggdrasil roots.");
		unittalk 0,strcharinfo(0)+": We came through the Yggdrasil roots.";
		next;
		
		mes "[Dead Mage]";
		mes "Ahhh, priviledge of the living.";
		npctalk "Dead Mage: Ahhh, priviledge of the living.";
		next;
		
		mes "[Dead Mage]";
		mes "Well That doesn't change much.";
		npctalk "Dead Mage: Well That doesn't change much.";
		next;
		
		mes "[Dead Mage]";
		mes "That girl you're trying to help is dead.";
		npctalk "Dead Mage: That girl you're trying to help is dead.";
		next;
		
		mes "[Dead Mage]";
		mes "So, it's not really your place to step in.";
		npctalk "Dead Mage: So, it's not really your place to step in.";
		select ("Alice is not dead");
		unittalk 0,strcharinfo(0)+": Alice is not dead.";
		next;
		
		mes "[Dead Mage]";
		mes "She looked awfully lost for someone that's not dead.";
		npctalk "Dead Mage: She looked awfully lost for someone that's not dead.";
		next;
		
		mes "[Dead Mage]";
		mes "You're saying she came through the roots aswell?";
		npctalk "Dead Mage: You're saying she came through the roots aswell?";
		select ("I don't know");
		unittalk 0,strcharinfo(0)+": I don't know.";
		next;
		
		mes "[Dead Mage]";
		mes "Hmm... You keep on doing what you're doing.";
		npctalk "Dead Mage: Hmm... You keep on doing what you're doing.";
		next;
		
		mes "[Dead Mage]";
		mes "I'll need to look into something.";
		npctalk "Dead Mage: I'll need to look into something.";
		next;
		
		mes "[Dead Mage]";
		mes "Here you go, it's ready.";
		npctalk "Dead Mage: Here you go, it's ready.";
		next;
		
		mes "[Dead Mage]";
		mes "With this you can remove the barrier that's at the stairs.";
		npctalk "Dead Mage: With this you can remove the barrier that's at the stairs.";
		next;
		
		mes "[Dead Mage]";
		mes "Go there, I'll meet you up later.";
		npctalk "Dead Mage: Go there, I'll meet you up later.";
		next;
		mes "You got Magic Breaker Stone.";
		disablenpc instance_npcname("Dead Magician#anightmare1");
		mapannounce 'second_map$, strcharinfo(0) +" got Magic Breaker Stone.",bc_map,"0x00ff99",FW_NORMAL,12;
		set 'main_event,11;
		close;
		
		
	}
	
	end;
	//Hera talk is on this npc
OnTimer5000:
	mapannounce 'second_map$,"Hera: I'll make sure to not do that again.",bc_map,"0xFF0000",FW_NORMAL,12;
	end;
OnTimer10000:
	mapannounce 'second_map$,"Hera: Maybe if you defeat the Shadow Guards I'll remove the barrier, hmmm.",bc_map,"0xFF0000",FW_NORMAL,12;
	stopnpctimer;
	end;

}





2@antgm,4,4,3	script	MonsterSpawner#anightmare1	792,{

OnInstanceInit:
	set .@npc_name$,instance_npcname("MonsterSpawner#anightmare1");
	areamonster 'second_map$,12,187,53,151,"Aliza",1746,3,.@npc_name$+"::OnAlizaDead1";
	areamonster 'second_map$,105,182,131,160,"Aliza",1746,2,.@npc_name$+"::OnAlizaDead2";
	areamonster 'second_map$,76,103,116,67,"Aliza",1746,2,.@npc_name$+"::OnAlizaDead3";
	areamonster 'second_map$,148,97,173,73,"Aliza",1746,1,.@npc_name$+"::OnAlizaDead4";
	
	areamonster 'second_map$,102,87,173,73,"Remenent of Hate",3401,4,.@npc_name$+"::OnGhostDead1";
	areamonster 'second_map$,118,75,125,20,"Remenent of Hate",3401,3,.@npc_name$+"::OnGhostDead2";
	areamonster 'second_map$,12,187,131,160,"Remenent of Hate",3401,5,.@npc_name$+"::OnGhostDead3";
	
	areamonster 'second_map$,102,87,173,73,"Carrier of Hate",3402,4,.@npc_name$+"::OnSkogulDead1";
	areamonster 'second_map$,118,75,125,20,"Carrier of Hate",3402,3,.@npc_name$+"::OnSkogulDead2";
	areamonster 'second_map$,12,187,131,160,"Carrier of Hate",3402,5,.@npc_name$+"::OnSkogulDead3";
	set .aliza_count1,0;
	set .aliza_count2,0;
	set .aliza_count3,0;
	set .aliza_count4,0;
	set .ghost_count1,0;
	set .ghost_count2,0;
	set .ghost_count3,0;
	
	set .skogul_count1,0;
	set .skogul_count2,0;
	set .skogul_count3,0;
	initnpctimer;
	end;
	
OnTimer20000:
	set .@npc_name$,instance_npcname("MonsterSpawner#anightmare1");
	if (rand(1,3)==1){set .@randnumber,rand(0,.aliza_count1);
		areamonster 'second_map$,12,187,53,151,"Aliza",1746,.@randnumber,.@npc_name$+"::OnAlizaDead1";
		.aliza_count1 -= .@randnumber;}
		
	if (rand(1,3)==1){set .@randnumber,rand(0,.aliza_count2);
		areamonster 'second_map$,105,182,131,160,"Aliza",1746,.@randnumber,.@npc_name$+"::OnAlizaDead2";
		.aliza_count2 -= .@randnumber;}
		
	if (rand(1,3)==1){set .@randnumber,rand(0,.aliza_count3);
		areamonster 'second_map$,76,103,116,67,"Aliza",1746,.@randnumber,.@npc_name$+"::OnAlizaDead3";
		.aliza_count3 -= .@randnumber;}
		
	if (rand(1,4)==1){set .@randnumber,rand(0,.aliza_count4);
		areamonster 'second_map$,148,97,173,73,"Aliza",1746,.@randnumber,.@npc_name$+"::OnAlizaDead4";
		.aliza_count4 -= .@randnumber;}
	end;
	
OnTimer21000:
	set .@npc_name$,instance_npcname("MonsterSpawner#anightmare1");
	if (rand(1,3)==1){set .@randnumber,rand(0,.ghost_count1);
		areamonster 'second_map$,102,87,173,73,"Remenent of Hate",3401,.@randnumber,.@npc_name$+"::OnGhostDead1";
		.ghost_count1 -= .@randnumber;}
		
	if (rand(1,3)==1){set .@randnumber,rand(0,.ghost_count2);
		areamonster 'second_map$,118,75,125,20,"Remenent of Hate",3401,.@randnumber,.@npc_name$+"::OnGhostDead2";
		.ghost_count2 -= .@randnumber;}
		
	if (rand(1,3)==1){set .@randnumber,rand(0,.ghost_count3);
		areamonster 'second_map$,12,187,131,160,"Remenent of Hate",3401,.@randnumber,.@npc_name$+"::OnGhostDead3";
		.ghost_count3 -= .@randnumber;}
	end;
	
OnTimer22000:
	set .@npc_name$,instance_npcname("MonsterSpawner#anightmare1");
	
	if (rand(1,3)==1){set .@randnumber,rand(0,.skogul_count1);
	areamonster 'second_map$,102,87,173,73,"Carrier of Hate",3402,.@randnumber,.@npc_name$+"::OnSkogulDead1";
	.skogul_count1 -= .@randnumber;}
	
	if (rand(1,3)==1){set .@randnumber,rand(0,.skogul_count2);
	areamonster 'second_map$,118,75,125,20,"Carrier of Hate",3402,.@randnumber,.@npc_name$+"::OnSkogulDead2";
	.skogul_count2 -= .@randnumber;}
	
	if (rand(1,3)==1){set .@randnumber,rand(0,.skogul_count3);
	areamonster 'second_map$,12,187,131,160,"Carrier of Hate",3402,.@randnumber,.@npc_name$+"::OnSkogulDead3";
	.skogul_count3 -= .@randnumber;}
	set .@mobcount,mobcount('second_map$,"all");
	stopnpctimer;
	initnpctimer;
	end;


OnAlizaDead1:
	.aliza_count1++;
	end;
OnAlizaDead2:
	.aliza_count2++;
	end;
OnAlizaDead3:
	.aliza_count3++;
	end;
OnAlizaDead4:
	.aliza_count4++;
	end;
OnGhostDead1:
	.ghost_count1++;
	end;
OnGhostDead2:
	.ghost_count2++;
	end;
OnGhostDead3:
	.ghost_count3++;
	end;
OnSkogulDead1:
	.skogul_count1++;
	end;
OnSkogulDead2:
	.skogul_count2++;
	end;
OnSkogulDead3:
	.skogul_count3++;
	end;

}


3@antgm,112,139,3	script	roomwarp#anightmare1	45,1,1,{
OnHeraDead:
	
	end;
OnTouch:
	warp 'third_map$,49,149;
	end;
}
3@antgm,52,149,3	script	roomwarp#anightmare2	45,1,1,{
OnTouch:
	warp 'third_map$,114,139;
	end;
}


3@antgm,46,206,4	script	Dead Magician#anightmare2	792,{
	set .@party_id,getcharid(1);
	if (getcharid(0) != getpartyleader(.@party_id,2)) {
		end;
	}
	
		if (anightmare_wakeup == 3){
			mes "^FF0000System message^000000";
			mes "Do you wish to skip this Dialogue?";
			next;
			if (select("No:Yes") == 2){
				disablenpc instance_npcname("Dead Magician#anightmare2");
				enablenpc instance_npcname("final#anightmare1");
				close;
			}
			
		}
	mes "[Dead Mage]";
	mes "Well...";
	npctalk "Dead Mage: Well...";
	select ("What is it?");
	unittalk 0,strcharinfo(0)+": What is it?";
	next;
	
	mes "[Dead Mage]";
	mes "My suspicions were true.";
	npctalk "Dead Mage: My suspicions were true.";
	next;
	
	mes "[Dead Mage]";
	mes "That girl is having a lucid nightmare.";
	npctalk "Dead Mage: That girl is having a lucid nightmare.";
	select ("What does that imply?");
	unittalk 0,strcharinfo(0)+": What does that imply?";
	next;

	mes "[Dead Mage]";
	mes "Only her soul is in the world of the dead.";
	npctalk "Dead Mage: Only her soul is in the world of the dead.";
	next;
	
	mes "[Dead Mage]";
	mes "This makes her very vulnerable.";
	npctalk "Dead Mage: This makes her very vulnerable.";
	select ("What can we do?");
	unittalk 0,strcharinfo(0)+": What can we do?";
	next;
	
	mes "[Dead Mage]";
	mes "She just need to wake up.";
	npctalk "Dead Mage: She just need to wake up.";
	next;

	mes "[Dead Mage]";
	mes "But I'm affraid Hera plans to eat her soul.";
	npctalk "Dead Mage: But I'm affraid Hera plans to eat her soul.";
	next;
	
	mes "[Dead Mage]";
	mes "You need to stop her.";
	npctalk "Dead Mage: You need to stop her.";
	next;

	mes "[Dead Mage]";
	mes "Please stop Hera.";
	npctalk "Dead Mage: Please stop Hera.";
	close2;
	disablenpc instance_npcname("Dead Magician#anightmare2");
	enablenpc instance_npcname("final#anightmare1");
	end;
	
OnInstanceInit:
	disablenpc instance_npcname("Dead Magician#anightmare2");
	end;
	
}


3@antgm,123,139,2	script	Alice#anightmare3	10013,8,14,{
	end;
OnTouch:
	set .@party_id,getcharid(1);
	if (getcharid(0) != getpartyleader(.@party_id,2)) {
		end;
	}
	if ('main_event !=14){end;}
	enablenpc instance_npcname("Hera#anightmare2");
	specialeffect 114;
	mes "[^FF0000Hera^000000]";
	mes "Oh no, you're are not taking her away.";
	npctalk "Hera: Oh no, you're are not taking her away.",instance_npcname("Hera#anightmare2");
	next;
	unitwalk getnpcid(0,instance_npcname("Hera#anightmare2")),123,138;
	mes "";
	close2;
	specialeffect 6;
	disablenpc instance_npcname("Hera#anightmare2");
	disablenpc instance_npcname("Alice#anightmare3");
	enablenpc instance_npcname("Dead Magician#anightmare2");
	set 'main_event,15;
	end;
	

}

3@antgm,119,136,6	script	Hera#anightmare2	3400,{
OnInstanceInit:
	disablenpc instance_npcname("Hera#anightmare2");
	end;

}
3@antgm,196,198,4	script	Hera#anightmare3	3400,{
	set .@party_id,getcharid(1);
	if (getcharid(0) != getpartyleader(.@party_id,2)) {
		end;
	}
	if ('main_event==16){
		monster ('third_map$,196,198,"Hera's Resentment",3400,1,instance_npcname("Dead Magician#anightmare3")+"::OnHeraDead");
		set 'hera_gid,$@mobid[0];
		disablenpc instance_npcname("Hera#anightmare3");
		unittalk 'hera_gid,"Hera: You will regret ever coming here!";
		set 'main_event,17;	
	}

}


3@antgm,196,194,0	script	Alice#anightmare4	1275,6,6,{
	end;
OnTouch:
	set .@party_id,getcharid(1);
	if (getcharid(0) != getpartyleader(.@party_id,2)) {
		end;
	}
	mes "["+strcharinfo(0)+"]";
	mes "Alice, Wake up!";
	unittalk 0,strcharinfo(0)+": Alice, Wake up!";
	
	next;
	mes "[^0000FFAlice^000000]";
	mes "I can't!";
	npctalk "Alice: I can't!";
	emotion ET_CRY;
	next;
	mes "[^0000FFAlice^000000]";
	mes "She's preventing me!";
	npctalk "Alice: She's preventing me!";
	next;
	mes "["+strcharinfo(0)+"]";
	mes "What?!";
	unittalk 0,strcharinfo(0)+": What?!";
	next;
	mes "[^FF0000Hera^000000]";
	mes "Hahaha! There is nothing you can do to wake up!";
	npctalk "Hera: Hahaha! There is nothing you can do to wake up!",instance_npcname("Hera#anightmare3");
	next;
	mes "[^FF0000Hera^000000]";
	mes "Your body is way too far to be dispelled!";
	npctalk "Hera: Your body is way too far to be dispelled!",instance_npcname("Hera#anightmare3");
	next;
	mes "["+strcharinfo(0)+"]";
	mes "You mean, something is stoping her from waking up physically?!";
	unittalk 0,strcharinfo(0)+": You mean, something is stoping her from waking up physically?!";
	next;
	mes "[^FF0000Hera^000000]";
	mes "I'm gonna consume your pure soul, it's gonna be a feast!";
	npctalk "Hera: I'm gonna consume your pure soul, it's gonna be a feast!",instance_npcname("Hera#anightmare3");
	next;
	unitwalk 0,195,195;
	mes "["+strcharinfo(0)+"]";
	mes "Stay away from her!";
	unittalk 0,strcharinfo(0)+": Stay away from her!";
	next;
	set 'main_event,16;
	delwall 'second_map$+"anightmare_walllist16";
	delwall 'second_map$+"anightmare_walllist17";
	delwall 'second_map$+"anightmare_walllist18";
	delwall 'second_map$+"anightmare_walllist19";
	unitwalk getnpcid(0,instance_npcname("Alice#anightmare4")),196,185;
	initnpctimer;
	mes "";
	next;
	playBGMall "108",'third_map$,166,227,229,162;
	initnpctimer instance_npcname("final#anightmare1");
	mes "[^FF0000Hera^000000]";
	mes "Ugh! Get out of my way!";
	npctalk "Hera: Ugh! Get out of my way!",instance_npcname("Hera#anightmare3");
	close2;
	monster ('third_map$,196,198,"Hera's Resentment",3400,1,instance_npcname("Dead Magician#anightmare3")+"::OnHeraDead");
	set 'hera_gid,$@mobid[0];
	disablenpc instance_npcname("Hera#anightmare3");
	unittalk 'hera_gid,"Hera: You will regret ever coming here!";
	set 'main_event,17;
	end;
	
OnTimer1000:
	stopnpctimer;
	disablenpc instance_npcname("Alice#anightmare4");
	end;
	
}


3@antgm,45,227,3	script	final#anightmare1	45,1,1,{

OnTimer1000:
	stopnpctimer;
	initnpctimer;
	if ('main_event > 16 && 'main_event < 21){
		playBGMall "108",'third_map$,166,227,229,162;
	}
	if ('main_event > 20){
		playBGMall "28",'third_map$,166,227,229,162;
	}
	if ('main_event == 17){
		getunitdata 'hera_gid,.@hera_hp;
		if (.@hera_hp[UMOB_HP]<2494695){
			unittalk 'hera_gid,"Hera: You just had to step in and ruin everything!";
			set 'main_event,18;
		}
		end;
	}
	if ('main_event == 18){
		getunitdata 'hera_gid,.@hera_hp;
		if (.@hera_hp[UMOB_HP]<2083803){
			unittalk 'hera_gid,"Hera: I'll show you the meaning of despair!";
			set 'main_event,19;
		}
		end;
	}
	if ('main_event == 19){
		getunitdata 'hera_gid,.@hera_hp;
		if (.@hera_hp[UMOB_HP]<1496817){
			unittalk 'hera_gid,"Hera: Go to hell!";
			set 'main_event,20;
		}
		end;
	}
	end;
OnInstanceInit:
	disablenpc instance_npcname("final#anightmare1");
	end;
OnTouch:
	warp 'third_map$,197,183;
	if ('main_event > 15 && 'main_event < 20){
		playBGM "108";
	}
	end;
}


3@antgm,195,198,3	script	Dead Magician#anightmare3	792,{
	set .@party_id,getcharid(1);
	if (getcharid(0) != getpartyleader(.@party_id,2)) {
		end;
	}
	if ('main_event==22){
		mes "[^0000ffAlice^000000]";
		mes "Please find me in Glastheim.";
		npctalk "Alice: Please find me in Glastheim.",instance_npcname("Alice#anightmare5");
		end;
	}
	mes "[Dead Mage]";
	mes "Thank you for stoping Hera.";
	npctalk "Dead Mage: Thank you for stoping Hera.",instance_npcname("Dead Magician#anightmare3");
	next;
	
	mes "[^0000ffAlice^000000]";
	mes "How am I going to wake up?";
	npctalk "Alice: How am I going to wake up?",instance_npcname("Alice#anightmare5");
	next;
	
	mes "[Dead Mage]";
	mes "Someone most likely put a spell on you.";
	npctalk "Dead Mage: Someone most likely put a spell on you.",instance_npcname("Dead Magician#anightmare3");
	next;
		
	mes "[Dead Mage]";
	mes "Fortunately for you, your saviors belong in your world.";
	npctalk "Dead Mage: Fortunately for you, your saviors belong in your world.",instance_npcname("Dead Magician#anightmare3");
	next;
	
	mes "[Dead Mage]";
	mes "They will need to wake you up.";
	npctalk "Dead Mage: They will need to wake you up.",instance_npcname("Dead Magician#anightmare3");
	next;
	
	mes "[Dead Mage]";
	mes "I wish you luck, my time here is done.";
	npctalk "Dead Mage: I wish you luck, my time here is done.",instance_npcname("Dead Magician#anightmare3");
	close2;
	disablenpc instance_npcname("Dead Magician#anightmare3");
	if (anightmare_wakeup == 0 || anightmare_wakeup == 3){
		set anightmare_wakeup,1;
	}
	initnpctimer instance_npcname("Alice#anightmare5");
	set 'main_event,22;
	end;

OnHeraDead:
	playBGMall "28",'third_map$,166,227,229,162;
	hideoffnpc instance_npcname("Dead Magician#anightmare3");
	hideoffnpc instance_npcname("Alice#anightmare5");
	set 'main_event,21;
	end;

OnInstanceInit:
	hideonnpc instance_npcname("Dead Magician#anightmare3");
	end;

}

3@antgm,199,194,2	script	Alice#anightmare5	10013,{
	set .@party_id,getcharid(1);
	if (getcharid(0) != getpartyleader(.@party_id,2)) {
		end;
	}
	if ('main_event==22){
		set anightmare_wakeup,2;
		
		mes "[^0000ffAlice^000000]";
		mes "hm...";
		next;
		mes "[^0000ffAlice^000000]";
		mes "Ah!";
		emotion ET_SURPRISE;
		npctalk "Alice: Ah!";
		next;
		mes "[^0000ffAlice^000000]";
		mes "*Gasp*";
		npctalk "Alice: *Gasp*";
		next;
		mes "[^0000ffAlice^000000]";
		mes "You saved me!";
		npctalk "Alice: You saved me!";
		next;
		emotion ET_CRY;
		mes "[^0000ffAlice^000000]";
		mes "I thought, I was never gonna wake up!";
		npctalk "Alice: I thought, I was never gonna wake up!";
		next;
		mes "[^0000ffAlice^000000]";
		mes "Why would she do this to me?";
		npctalk "Alice: Why would she do this to me?";
		select ("Demons...");
		unittalk 0,strcharinfo(0)+": Demons, they have no reasons.";
		next;
		mes "[^0000ffAlice^000000]";
		mes "She was especially mean.";
		npctalk "Alice: She was especially mean.";
		next;
		mes "[^0000ffAlice^000000]";
		mes "But you saved me!";
		npctalk "Alice: But you saved me!";
		emotion ET_OK;
		next;
		mes "[^0000ffAlice^000000]";
		mes "Thank you!";
		npctalk "Alice: Thank you!";
		emotion ET_THANKS;
		next;
		mes "[^0000ffAlice^000000]";
		mes "Do you want to leave now ?";
		npctalk "Alice: Do you want to leave now ?";
		next;
		if(select ("Yes please...:No, not yet") == 1){
			mes "[^0000ffAlice^000000]";
			mes "Alice: Please accept this as a token my gratitude";
			npctalk "Alice: Please accept this as a token my gratitude.";
			close2;
			initnpctimer;
			/*Reward*/
			//insert reward here for waking up alice
			//set quest to done (will be reseted next time you do the instance.)
			//so this is repeatble
			getitem_map 6658,50,strcharinfo(3),1,getcharid(1);
			getexp_map 2222222,2222222,strcharinfo(3),1,getcharid(1);
			
			mapwarp strcharinfo(3), "hollowtown",203,146,2,getcharid(1);
		}
		unittalk 0,strcharinfo(0)+": No, not yet.";
		next;
		mes "[^0000ffAlice^000000]";
		mes "OK then...";
		npctalk "Alice: OK then...";
		close;
	}
	
	mes "[Dead Mage]";
	mes "Thank you for stoping Hera.";
	npctalk "Dead Mage: Thank you for stoping Hera.",instance_npcname("Dead Magician#anightmare3");
	next;
	
	mes "[^0000ffAlice^000000]";
	mes "How am I going to wake up?";
	npctalk "Alice: How am I going to wake up?",instance_npcname("Alice#anightmare5");
	next;
	
	mes "[Dead Mage]";
	mes "Someone most likely put a spell on you.";
	npctalk "Dead Mage: Someone most likely put a spell on you.",instance_npcname("Dead Magician#anightmare3");
	next;
	
	mes "[Dead Mage]";
	mes "You will just need someone to dispel you with a ^FF0000Yellow Gemstone ^000000and ^0000FFHoly Water^000000.";
	npctalk "Dead Mage: You will just need someone to dispel you with a Yellow Gemstone and Holy Water.",instance_npcname("Dead Magician#anightmare3");
	next;
	
	mes "[Dead Mage]";
	mes "Fortunately for you, your saviors belong in your world.";
	npctalk "Dead Mage: Fortunately for you, your saviors belong in your world.",instance_npcname("Dead Magician#anightmare3");
	next;
	
	mes "[Dead Mage]";
	mes "They will need to find you in the real world and wake you up.";
	npctalk "Dead Mage: They will need to find you in the real world and wake you up.",instance_npcname("Dead Magician#anightmare3");
	next;
	
	mes "[Dead Mage]";
	mes "Where were you?";
	npctalk "Dead Mage: Where were you?",instance_npcname("Dead Magician#anightmare3");
	next;
	
	mes "[^0000ffAlice^000000]";
	mes "Glastheim courtyard.";
	npctalk "Alice: Glastheim courtyard.",instance_npcname("Alice#anightmare5");
	next;
	
	mes "[Dead Mage]";
	mes "Go back to your world and travel to glastheim to find her.";
	npctalk "Dead Mage: Go back to your world and travel to glastheim to find her.",instance_npcname("Dead Magician#anightmare3");
	next;
	mes "[Dead Mage]";
	mes "I wish you luck, my time here is done.";
	npctalk "Dead Mage: I wish you luck, my time here is done.",instance_npcname("Dead Magician#anightmare3");
	close2;
	disablenpc instance_npcname("Dead Magician#anightmare3");
	if (anightmare_wakeup == 0 || anightmare_wakeup == 3){
		set anightmare_wakeup,1;
	}
	initnpctimer;
	set 'main_event,22;
	end;

OnInstanceInit:
	hideonnpc instance_npcname("Alice#anightmare5");
	end;
}

2@antgm,149,92,6	script	Dead Swordman#anightmare1	796,{
	if ('door_opened == 1){
		mes "[Dead Swordman]";
		mes "Hey look at that, the door is opened!";
		next;
		mes "[Dead Swordman]";
		mes "Ts'about goddamn time if you ask me.";
		next;
		mes "[Dead Swordman]";
		mes "BUT THIS CHICKEN DOESN'T FREAKING TALK!";
		specialeffect 102;
		close;
	}
	mes "[Dead Swordman]";
	mes "That door is always locked!";
	mes "Why is it always locked!?";
	next;
	mes "[Dead Swordman]";
	mes "It's making me so angry, I don't know why! If only I had a ^FF0000Key^000000.";
	if (countitem(7026) < 1 && countitem(7027) < 1){
		close;
	}
	next;
	mes "[Dead Swordman]";
	mes "Hey you got a ^FF0000Key^000000... Can I have it?";
	next;
	switch (select("Yes:No")){
		case 1:
			mes "[Dead Swordman]";
			mes "Hehehe, Thanks!";
			close2;
				if (countitem(7026) > 0){
					delitem 7026,1;
				}else{
					delitem 7027,1;
				}
			disablenpc instance_npcname("Dead Swordman#anightmare1");
			end;
		case 2:
			mes "[Dead Swordman]";
			mes "Why not?!";
			close;
			
	}
}

2@antgm,152,92,2	script	Chicken#anightmare1	800,{
	mes "[Chicken]";
	mes "...";
	close;
}

2@antgm,82,78,4	script	Dead Guy#anightmare1	849,{
	mes "["+strcharinfo(0)+"]";
	mes "He's dead...";
	next;
	mes "[Dead Guy]";
	mes "Some more than other.";
	close;
}


2@antgm,79,98,5	script	Sleepy Guy#anightmare1	795,{
	mes "[Sleepy Guy]";
	mes "I'm so tired, but how do you sleep when you're dead?";
	next;
	mes "[Sleepy Guy]";
	mes "Sleeping was suposed to be a physical need.";
	next;
	mes "[Sleepy Guy]";
	mes "Why am I tired if I do not have a physical body anymore?";
	next;
	mes "["+strcharinfo(0)+"]";
	mes "Maybe you're not tired, maybe its something else.";
	next;
	mes "[Sleepy Guy]";
	mes "Maybe you're right.";
	close;
}

3@antgm,45,43,5	script	Gardener#anightmare1	791,{
	if ('main_event > 13){
		mes "[Gardener]";
		mes "You almost ruined the garden.";
		close;
	}
	if ('main_event == 13){
		mes "[Gardener]";
		mes "Please do not cause any ruckus in the garden.";
		close;
	}

	mes "[Gardener]";
	mes "Welcome to the garden.";
	next;
	mes "[Sleepy Guy]";
	mes "Please do not pull the beautiful weeds out.";
	close;
}

2@antgm,37,174,3	script	Maid#anightmare1	791,{
	mes "[Maid]";
	mes "Welcome back master,";
	mes "Welcome back master,";
	mes "Welcome back master,";
	mes "Welcome back master,";
	mes "...";
	close;

}

